<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remora Calendar</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --dartmouth-green: #00693E;
      --light-green: #E8F5E9;
    }
    .current-time-indicator {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #DC2626;
      z-index: 10;
      pointer-events: none;
    }
    .current-time-indicator::before {
      content: '';
      position: absolute;
      left: -6px;
      top: -5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #DC2626;
    }
    .event-dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CalendarApp = () => {
      const [isSignedIn, setIsSignedIn] = useState(false);
      const [calendars, setCalendars] = useState([]);
      const [events, setEvents] = useState([]);
      const [view, setView] = useState('day');
      const [currentDate, setCurrentDate] = useState(new Date());
      const [columns, setColumns] = useState([]);
      const [showSettings, setShowSettings] = useState(false);
      const [defaultCalendar, setDefaultCalendar] = useState('');
      const [showEventModal, setShowEventModal] = useState(false);
      const [selectedEvent, setSelectedEvent] = useState(null);
      const [isDragging, setIsDragging] = useState(false);
      const [dragStart, setDragStart] = useState(null);
      const [dragEnd, setDragEnd] = useState(null);
      const [currentTime, setCurrentTime] = useState(new Date());
      const clientId = '788943371871-n713sgr9t3oifkev2abln7615eulgbv4.apps.googleusercontent.com';

      // Update current time every minute
      useEffect(() => {
        const interval = setInterval(() => {
          setCurrentTime(new Date());
        }, 60000);
        return () => clearInterval(interval);
      }, []);

      // Keyboard shortcuts
      useEffect(() => {
        const handleKeyPress = (e) => {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
          if (e.key === 'd') setView('day');
          if (e.key === 'w') setView('week');
          if (e.key === 'm') setView('month');
        };
        window.addEventListener('keydown', handleKeyPress);
        return () => window.removeEventListener('keydown', handleKeyPress);
      }, []);

      useEffect(() => {
        const hash = window.location.hash;
        if (hash) {
          const params = new URLSearchParams(hash.substring(1));
          const accessToken = params.get('access_token');
          if (accessToken) {
            localStorage.setItem('google_access_token', accessToken);
            window.location.hash = '';
            loadCalendarsAndEvents(accessToken);
          }
        } else {
          const token = localStorage.getItem('google_access_token');
          if (token) {
            loadCalendarsAndEvents(token);
          }
        }

        // Load default calendar from localStorage
        const savedDefault = localStorage.getItem('default_calendar');
        if (savedDefault) {
          setDefaultCalendar(savedDefault);
        }
      }, []);

      const loadCalendarsAndEvents = async (accessToken) => {
        await loadCalendars(accessToken);
        await loadEvents(accessToken);
        setIsSignedIn(true);
      };

      const signIn = () => {
        let redirectUri = window.location.href.split('#')[0].split('?')[0];
        if (!redirectUri.endsWith('/')) {
          redirectUri += '/';
        }
        const scope = 'https://www.googleapis.com/auth/calendar';
        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${encodeURIComponent(scope)}&prompt=consent`;
        window.location.href = authUrl;
      };

      const signOut = () => {
        localStorage.removeItem('google_access_token');
        setIsSignedIn(false);
        setCalendars([]);
        setEvents([]);
      };

      const loadCalendars = async (accessToken) => {
        try {
          const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList', {
            headers: { Authorization: `Bearer ${accessToken}` }
          });
          const data = await response.json();
          setCalendars(data.items || []);
          
          const savedColumns = localStorage.getItem('calendar_columns');
          if (savedColumns) {
            setColumns(JSON.parse(savedColumns));
          } else {
            setColumns([{ id: '1', name: 'Column 1', calendarIds: data.items?.map(cal => cal.id) || [] }]);
          }
          
          const savedDefault = localStorage.getItem('default_calendar');
          if (savedDefault) {
            setDefaultCalendar(savedDefault);
          } else if (data.items && data.items.length > 0) {
            setDefaultCalendar(data.items[0].id);
          }
        } catch (error) {
          console.error('Error loading calendars:', error);
          if (error.message?.includes('401')) {
            signOut();
          }
        }
      };

      const loadEvents = async (accessToken) => {
        try {
          const token = accessToken || localStorage.getItem('google_access_token');
          const timeMin = new Date(currentDate);
          timeMin.setDate(1);
          const timeMax = new Date(currentDate);
          timeMax.setMonth(timeMax.getMonth() + 1);

          const allEvents = [];
          for (const calendar of calendars) {
            const response = await fetch(
              `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.id)}/events?timeMin=${timeMin.toISOString()}&timeMax=${timeMax.toISOString()}&singleEvents=true`,
              { headers: { Authorization: `Bearer ${token}` } }
            );
            const data = await response.json();
            if (data.items) {
              allEvents.push(...data.items.map(event => ({ ...event, calendarId: calendar.id, calendarColor: calendar.backgroundColor })));
            }
          }
          setEvents(allEvents);
        } catch (error) {
          console.error('Error loading events:', error);
        }
      };

      useEffect(() => {
        if (calendars.length > 0 && isSignedIn) {
          loadEvents();
        }
      }, [currentDate, calendars]);

      const createEvent = async (eventData) => {
        try {
          const token = localStorage.getItem('google_access_token');
          const calendarId = eventData.calendarId || defaultCalendar;
          
          const response = await fetch(
            `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`,
            {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                summary: eventData.title,
                description: eventData.description,
                start: { dateTime: eventData.start },
                end: { dateTime: eventData.end }
              })
            }
          );
          
          if (response.ok) {
            await loadEvents();
            setShowEventModal(false);
            setSelectedEvent(null);
          }
        } catch (error) {
          console.error('Error creating event:', error);
        }
      };

      const updateEvent = async (eventData) => {
        try {
          const token = localStorage.getItem('google_access_token');
          
          const response = await fetch(
            `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(eventData.calendarId)}/events/${eventData.id}`,
            {
              method: 'PUT',
              headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                summary: eventData.title,
                description: eventData.description,
                start: { dateTime: eventData.start },
                end: { dateTime: eventData.end }
              })
            }
          );
          
          if (response.ok) {
            await loadEvents();
            setShowEventModal(false);
            setSelectedEvent(null);
          }
        } catch (error) {
          console.error('Error updating event:', error);
        }
      };

      const deleteEvent = async (event) => {
        try {
          const token = localStorage.getItem('google_access_token');
          
          await fetch(
            `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(event.calendarId)}/events/${event.id}`,
            {
              method: 'DELETE',
              headers: { Authorization: `Bearer ${token}` }
            }
          );
          
          await loadEvents();
          setShowEventModal(false);
          setSelectedEvent(null);
        } catch (error) {
          console.error('Error deleting event:', error);
        }
      };

      const addColumn = () => {
        const newColumn = {
          id: Date.now().toString(),
          name: `Column ${columns.length + 1}`,
          calendarIds: []
        };
        const updated = [...columns, newColumn];
        setColumns(updated);
        localStorage.setItem('calendar_columns', JSON.stringify(updated));
      };

      const moveCalendarToColumn = (calendarId, targetColumnId) => {
        const updated = columns.map(col => ({
          ...col,
          calendarIds: col.id === targetColumnId 
            ? [...col.calendarIds.filter(id => id !== calendarId), calendarId]
            : col.calendarIds.filter(id => id !== calendarId)
        }));
        setColumns(updated);
        localStorage.setItem('calendar_columns', JSON.stringify(updated));
      };

      const removeColumn = (columnId) => {
        if (columns.length === 1) return;
        const updated = columns.filter(col => col.id !== columnId);
        setColumns(updated);
        localStorage.setItem('calendar_columns', JSON.stringify(updated));
      };

      const handleMouseDown = (e, hour, columnId) => {
        if (e.target.closest('.event-block')) return;
        const rect = e.currentTarget.getBoundingClientRect();
        const minutes = Math.floor(((e.clientY - rect.top) / rect.height) * 60);
        const start = new Date(currentDate);
        start.setHours(hour, minutes, 0, 0);
        setIsDragging(true);
        setDragStart({ time: start, columnId });
        setDragEnd({ time: start, columnId });
      };

      const handleMouseMove = (e, hour) => {
        if (!isDragging) return;
        const rect = e.currentTarget.getBoundingClientRect();
        const minutes = Math.floor(((e.clientY - rect.top) / rect.height) * 60);
        const end = new Date(currentDate);
        end.setHours(hour, minutes, 0, 0);
        setDragEnd({ time: end, columnId: dragStart.columnId });
      };

      const handleMouseUp = () => {
        if (!isDragging || !dragStart || !dragEnd) return;
        setIsDragging(false);
        
        const start = dragStart.time < dragEnd.time ? dragStart.time : dragEnd.time;
        const end = dragStart.time < dragEnd.time ? dragEnd.time : dragStart.time;
        
        if (end - start < 15 * 60 * 1000) {
          end.setMinutes(start.getMinutes() + 30);
        }

        const column = columns.find(c => c.id === dragStart.columnId);
        const calendarId = column?.calendarIds[0] || defaultCalendar;

        setSelectedEvent({
          start: start.toISOString(),
          end: end.toISOString(),
          calendarId: calendarId
        });
        setShowEventModal(true);
        setDragStart(null);
        setDragEnd(null);
      };

      const findSimilarEvents = (events) => {
        const groups = [];
        const processed = new Set();

        events.forEach((event, i) => {
          if (processed.has(i)) return;
          
          const similar = [event];
          processed.add(i);

          events.forEach((other, j) => {
            if (i === j || processed.has(j)) return;
            
            const event1Start = new Date(event.start.dateTime || event.start.date);
            const event1End = new Date(event.end.dateTime || event.end.date);
            const event2Start = new Date(other.start.dateTime || other.start.date);
            const event2End = new Date(other.end.dateTime || other.end.date);

            if (Math.abs(event1Start - event2Start) < 5 * 60 * 1000 && 
                Math.abs(event1End - event2End) < 5 * 60 * 1000) {
              const similarity = calculateSimilarity(event.summary, other.summary);
              if (similarity > 0.6) {
                similar.push(other);
                processed.add(j);
              }
            }
          });

          if (similar.length > 1) {
            groups.push(similar);
          }
        });

        return groups;
      };

      const calculateSimilarity = (str1, str2) => {
        const s1 = str1.toLowerCase();
        const s2 = str2.toLowerCase();
        const longer = s1.length > s2.length ? s1 : s2;
        const shorter = s1.length > s2.length ? s2 : s1;
        if (longer.length === 0) return 1.0;
        const editDistance = (s1, s2) => {
          const costs = [];
          for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
              if (i === 0) {
                costs[j] = j;
              } else if (j > 0) {
                let newValue = costs[j - 1];
                if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                  newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                }
                costs[j - 1] = lastValue;
                lastValue = newValue;
              }
            }
            if (i > 0) costs[s2.length] = lastValue;
          }
          return costs[s2.length];
        };
        return (longer.length - editDistance(longer, shorter)) / longer.length;
      };

      const layoutOverlappingEvents = (events) => {
        const sorted = [...events].sort((a, b) => {
          const aStart = new Date(a.start.dateTime || a.start.date);
          const bStart = new Date(b.start.dateTime || b.start.date);
          return aStart - bStart;
        });

        const columns = [];
        sorted.forEach(event => {
          const eventStart = new Date(event.start.dateTime || event.start.date);
          const eventEnd = new Date(event.end.dateTime || event.end.date);

          let placed = false;
          for (let col of columns) {
            const lastEvent = col[col.length - 1];
            const lastEnd = new Date(lastEvent.end.dateTime || lastEvent.end.date);
            if (eventStart >= lastEnd) {
              col.push(event);
              placed = true;
              break;
            }
          }
          if (!placed) {
            columns.push([event]);
          }
        });

        return sorted.map(event => {
          const colIndex = columns.findIndex(col => col.includes(event));
          return {
            ...event,
            layoutColumn: colIndex,
            totalColumns: columns.length
          };
        });
      };

      const renderDayView = () => {
        const hours = Array.from({ length: 18 }, (_, i) => i + 6);
        const dayEvents = events.filter(event => {
          const eventDate = new Date(event.start.dateTime || event.start.date);
          return eventDate.toDateString() === currentDate.toDateString();
        });

        const allDayEvents = dayEvents.filter(event => !event.start.dateTime);
        const timedEvents = dayEvents.filter(event => event.start.dateTime);
        const similarGroups = findSimilarEvents(timedEvents);

        const now = new Date();
        const isToday = currentDate.toDateString() === now.toDateString();
        const currentTimeTop = isToday ? ((now.getHours() - 6) * 64) + (now.getMinutes() / 60 * 64) : null;

        return (
          <div className="flex-1 overflow-auto">
            {allDayEvents.length > 0 && (
              <div className="border-b bg-gray-50 p-2">
                <div className="flex gap-2 flex-wrap">
                  {allDayEvents.map(event => (
                    <div
                      key={event.id}
                      className="px-3 py-1 rounded text-sm text-white cursor-pointer"
                      style={{ backgroundColor: event.calendarColor || 'var(--dartmouth-green)' }}
                      onClick={() => {
                        setSelectedEvent(event);
                        setShowEventModal(true);
                      }}
                    >
                      {event.summary}
                    </div>
                  ))}
                </div>
              </div>
            )}

            <div className="flex border-b bg-gray-50">
              <div className="w-16 flex-shrink-0 border-r"></div>
              {columns.map((column, idx) => (
                <div key={column.id} className="flex-1 p-2 border-r font-semibold text-center flex items-center justify-center gap-2">
                  {column.name}
                  {idx === columns.length - 1 && (
                    <button
                      onClick={addColumn}
                      className="p-1 hover:bg-gray-200 rounded"
                      title="Add Column"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                      </svg>
                    </button>
                  )}
                </div>
              ))}
            </div>
            
            <div className="flex relative">
              <div className="w-16 flex-shrink-0">
                {hours.map(hour => (
                  <div key={hour} className="h-16 border-b text-xs text-gray-500 p-1">
                    {hour % 12 || 12}{hour >= 12 ? 'PM' : 'AM'}
                  </div>
                ))}
              </div>
              
              {columns.map(column => {
                const columnEvents = timedEvents.filter(event => column.calendarIds.includes(event.calendarId));
                const layoutedEvents = layoutOverlappingEvents(columnEvents);
                
                return (
                  <div key={column.id} className="flex-1 border-r relative">
                    {hours.map(hour => (
                      <div
                        key={hour}
                        className="h-16 border-b hover:bg-gray-50 cursor-crosshair relative"
                        onMouseDown={(e) => handleMouseDown(e, hour, column.id)}
                        onMouseMove={(e) => handleMouseMove(e, hour)}
                        onMouseUp={handleMouseUp}
                      >
                        {hour !== 23 && <div className="absolute top-1/2 left-0 right-0 border-t border-gray-200"></div>}
                      </div>
                    ))}
                    
                    {layoutedEvents.map(event => {
                      const start = new Date(event.start.dateTime);
                      const end = new Date(event.end.dateTime);
                      const top = ((start.getHours() - 6) * 64) + (start.getMinutes() / 60 * 64);
                      const height = ((end - start) / (1000 * 60 * 60)) * 64;
                      
                      const similarGroup = similarGroups.find(group => group.some(e => e.id === event.id));
                      const isInGroup = similarGroup && similarGroup.length > 1;
                      const groupCalendars = isInGroup ? similarGroup.map(e => e.calendarId) : [event.calendarId];
                      const spansColumns = isInGroup && groupCalendars.length > 1;
                      
                      const leftOffset = event.totalColumns > 1 ? (event.layoutColumn / event.totalColumns * 100) : 0;
                      const widthPercent = event.totalColumns > 1 ? (100 / event.totalColumns) : 100;

                      let backgroundColor = event.calendarColor || 'var(--dartmouth-green)';
                      if (isInGroup && groupCalendars.length > 1) {
                        const colors = groupCalendars.map(id => calendars.find(c => c.id === id)?.backgroundColor || 'var(--dartmouth-green)');
                        backgroundColor = `linear-gradient(90deg, ${colors.join(', ')})`;
                      }
                      
                      return (
                        <div
                          key={event.id}
                          className="absolute rounded text-xs text-white cursor-pointer overflow-hidden event-block"
                          style={{
                            top: `${top}px`,
                            height: `${height}px`,
                            left: `${leftOffset}%`,
                            width: `calc(${widthPercent}% - ${event.totalColumns > 1 ? '2px' : '4px'})`,
                            background: backgroundColor,
                            border: event.totalColumns > 1 ? '1px solid white' : 'none',
                            marginLeft: event.totalColumns > 1 ? '1px' : '2px',
                            marginRight: event.totalColumns > 1 ? '1px' : '2px'
                          }}
                          onClick={() => {
                            setSelectedEvent(event);
                            setShowEventModal(true);
                          }}
                        >
                          <div className="p-1">
                            <div className="font-semibold truncate">{event.summary}</div>
                            <div className="text-xs opacity-90">
                              {start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                            </div>
                          </div>
                        </div>
                      );
                    })}

                    {isDragging && dragStart?.columnId === column.id && dragStart && dragEnd && (
                      <div
                        className="absolute left-1 right-1 rounded bg-blue-400 opacity-50 pointer-events-none"
                        style={{
                          top: `${Math.min(
                            ((dragStart.time.getHours() - 6) * 64) + (dragStart.time.getMinutes() / 60 * 64),
                            ((dragEnd.time.getHours() - 6) * 64) + (dragEnd.time.getMinutes() / 60 * 64)
                          )}px`,
                          height: `${Math.abs(
                            (((dragEnd.time.getHours() - 6) * 64) + (dragEnd.time.getMinutes() / 60 * 64)) -
                            (((dragStart.time.getHours() - 6) * 64) + (dragStart.time.getMinutes() / 60 * 64))
                          )}px`
                        }}
                      />
                    )}

                    {isToday && currentTimeTop !== null && currentTimeTop >= 0 && currentTimeTop <= 18 * 64 && (
                      <div className="current-time-indicator" style={{ top: `${currentTimeTop}px` }} />
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        );
      };

      const renderWeekView = () => {
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
        const days = Array.from({ length: 7 }, (_, i) => {
          const day = new Date(startOfWeek);
          day.setDate(startOfWeek.getDate() + i);
          return day;
        });

        const hours = Array.from({ length: 18 }, (_, i) => i + 6);
        const now = new Date();

        return (
          <div className="flex-1 overflow-auto">
            <div className="flex border-b bg-gray-50">
              <div className="w-16 flex-shrink-0 border-r"></div>
              {days.map(day => (
                <div key={day.toISOString()} className="flex-1 p-2 border-r text-center">
                  <div className="font-semibold">{day.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                  <div className="text-sm text-gray-600">{day.getDate()}</div>
                </div>
              ))}
            </div>

            <div className="flex">
              <div className="w-16 flex-shrink-0">
                {hours.map(hour => (
                  <div key={hour} className="h-16 border-b text-xs text-gray-500 p-1">
                    {hour % 12 || 12}{hour >= 12 ? 'PM' : 'AM'}
                  </div>
                ))}
              </div>

              {days.map(day => {
                const dayEvents = events.filter(event => {
                  const eventDate = new Date(event.start.dateTime || event.start.date);
                  return eventDate.toDateString() === day.toDateString() && event.start.dateTime;
                });

                const layoutedEvents = layoutOverlappingEvents(dayEvents);
                const isToday = day.toDateString() === now.toDateString();
                const currentTimeTop = isToday ? ((now.getHours() - 6) * 64) + (now.getMinutes() / 60 * 64) : null;

                return (
                  <div key={day.toISOString()} className="flex-1 border-r relative">
                    {hours.map(hour => (
                      <div key={hour} className="h-16 border-b hover:bg-gray-50 relative">
                        {hour !== 23 && <div className="absolute top-1/2 left-0 right-0 border-t border-gray-200"></div>}
                      </div>
                    ))}

                    {layoutedEvents.map(event => {
                      const start = new Date(event.start.dateTime);
                      const end = new Date(event.end.dateTime);
                      const top = ((start.getHours() - 6) * 64) + (start.getMinutes() / 60 * 64);
                      const height = ((end - start) / (1000 * 60 * 60)) * 64;
                      
                      const leftOffset = event.totalColumns > 1 ? (event.layoutColumn / event.totalColumns * 100) : 0;
                      const widthPercent = event.totalColumns > 1 ? (100 / event.totalColumns) : 100;

                      return (
                        <div
                          key={event.id}
                          className="absolute rounded text-xs text-white cursor-pointer overflow-hidden"
                          style={{
                            top: `${top}px`,
                            height: `${height}px`,
                            left: `${leftOffset}%`,
                            width: `calc(${widthPercent}% - ${event.totalColumns > 1 ? '2px' : '4px'})`,
                            backgroundColor: event.calendarColor || 'var(--dartmouth-green)',
                            border: event.totalColumns > 1 ? '1px solid white' : 'none',
                            marginLeft: '2px',
                            marginRight: '2px'
                          }}
                          onClick={() => {
                            setSelectedEvent(event);
                            setShowEventModal(true);
                          }}
                        >
                          <div className="p-1">
                            <div className="font-semibold truncate">{event.summary}</div>
                          </div>
                        </div>
                      );
                    })}

                    {isToday && currentTimeTop !== null && currentTimeTop >= 0 && currentTimeTop <= 18 * 64 && (
                      <div className="current-time-indicator" style={{ top: `${currentTimeTop}px` }} />
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        );
      };

      const renderMonthView = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - startDate.getDay());
        
        const days = [];
        const current = new Date(startDate);
        while (days.length < 42) {
          days.push(new Date(current));
          current.setDate(current.getDate() + 1);
        }

        return (
          <div className="flex-1 overflow-auto p-4">
            <div className="grid grid-cols-7 gap-px bg-gray-200">
              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                <div key={day} className="bg-gray-50 p-2 text-center font-semibold text-sm" style={{ color: 'var(--dartmouth-green)' }}>
                  {day}
                </div>
              ))}
              {days.map(day => (
                <div
                  key={day.toISOString()}
                  className={`bg-white p-2 min-h-[100px] ${
                    day.getMonth() !== month ? 'text-gray-400' : ''
                  }`}
                >
                  <div className="font-semibold mb-1">{day.getDate()}</div>
                  {events
                    .filter(event => {
                      const eventDate = new Date(event.start.dateTime || event.start.date);
                      return eventDate.toDateString() === day.toDateString();
                    })
                    .slice(0, 3)
                    .map(event => (
                      <div
                        key={event.id}
                        className="mb-1 p-1 rounded text-xs text-white cursor-pointer truncate"
                        style={{ backgroundColor: event.calendarColor || 'var(--dartmouth-green)' }}
                        onClick={() => {
                          setSelectedEvent(event);
                          setShowEventModal(true);
                        }}
                      >
                        {event.summary}
                      </div>
                    ))}
                </div>
              ))}
            </div>
          </div>
        );
      };

      if (!isSignedIn) {
        return (
          <div className="h-screen flex items-center justify-center" style={{ backgroundColor: 'var(--light-green)' }}>
            <div className="bg-white rounded-lg shadow-lg p-8 text-center">
              <svg className="w-16 h-16 mx-auto mb-4" viewBox="0 0 64 64" fill="var(--dartmouth-green)">
                <path d="M32 8 C20 8, 12 16, 12 28 C12 36, 16 42, 22 46 L20 56 L32 50 L44 56 L42 46 C48 42, 52 36, 52 28 C52 16, 44 8, 32 8 M32 12 C42 12, 48 18, 48 28 C48 34, 45 39, 40 42 L38 44 L39 50 L32 46 L25 50 L26 44 L24 42 C19 39, 16 34, 16 28 C16 18, 22 12, 32 12" />
                <ellipse cx="26" cy="26" rx="3" ry="4" />
                <ellipse cx="38" cy="26" rx="3" ry="4" />
                <path d="M24 32 Q32 36 40 32" stroke="var(--dartmouth-green)" strokeWidth="2" fill="none" />
              </svg>
              <h1 className="text-2xl font-bold mb-4" style={{ color: 'var(--dartmouth-green)' }}>Remora Calendar</h1>
              <button
                onClick={signIn}
                className="text-white rounded px-6 py-3 hover:opacity-90"
                style={{ backgroundColor: 'var(--dartmouth-green)' }}
              >
                Sign in with Google
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="h-screen flex flex-col bg-white">
          <div className="border-b p-4 flex items-center justify-between" style={{ borderColor: 'var(--dartmouth-green)' }}>
            <div className="flex items-center gap-4">
              <svg className="w-6 h-6" viewBox="0 0 64 64" fill="var(--dartmouth-green)">
                <path d="M32 8 C20 8, 12 16, 12 28 C12 36, 16 42, 22 46 L20 56 L32 50 L44 56 L42 46 C48 42, 52 36, 52 28 C52 16, 44 8, 32 8 M32 12 C42 12, 48 18, 48 28 C48 34, 45 39, 40 42 L38 44 L39 50 L32 46 L25 50 L26 44 L24 42 C19 39, 16 34, 16 28 C16 18, 22 12, 32 12" />
                <ellipse cx="26" cy="26" rx="3" ry="4" />
                <ellipse cx="38" cy="26" rx="3" ry="4" />
                <path d="M24 32 Q32 36 40 32" stroke="var(--dartmouth-green)" strokeWidth="2" fill="none" />
              </svg>
              <h1 className="text-xl font-bold" style={{ color: 'var(--dartmouth-green)' }}>Remora</h1>
              
              <div className="flex items-center gap-2 ml-8">
                <button
                  onClick={() => {
                    const newDate = new Date(currentDate);
                    if (view === 'day') newDate.setDate(newDate.getDate() - 1);
                    else if (view === 'week') newDate.setDate(newDate.getDate() - 7);
                    else newDate.setMonth(newDate.getMonth() - 1);
                    setCurrentDate(newDate);
                  }}
                  className="p-1 hover:bg-gray-100 rounded"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                
                <button
                  onClick={() => setCurrentDate(new Date())}
                  className="px-3 py-1 rounded"
                  style={{ backgroundColor: 'var(--light-green)', color: 'var(--dartmouth-green)' }}
                >
                  Today
                </button>
                
                <button
                  onClick={() => {
                    const newDate = new Date(currentDate);
                    if (view === 'day') newDate.setDate(newDate.getDate() + 1);
                    else if (view === 'week') newDate.setDate(newDate.getDate() + 7);
                    else newDate.setMonth(newDate.getMonth() + 1);
                    setCurrentDate(newDate);
                  }}
                  className="p-1 hover:bg-gray-100 rounded"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </button>
                
                <span className="ml-4 font-semibold">
                  {currentDate.toLocaleDateString('en-US', { 
                    month: 'long', 
                    day: view === 'day' ? 'numeric' : undefined,
                    year: 'numeric' 
                  })}
                </span>
              </div>
            </div>
            
            <div className="flex items-center gap-2">
              <div className="flex border rounded overflow-hidden" style={{ borderColor: 'var(--dartmouth-green)' }}>
                <button
                  onClick={() => setView('day')}
                  className={`px-4 py-2 ${view === 'day' ? 'text-white' : 'hover:bg-gray-100'}`}
                  style={view === 'day' ? { backgroundColor: 'var(--dartmouth-green)' } : {}}
                >
                  Day
                </button>
                <button
                  onClick={() => setView('week')}
                  className={`px-4 py-2 ${view === 'week' ? 'text-white' : 'hover:bg-gray-100'}`}
                  style={view === 'week' ? { backgroundColor: 'var(--dartmouth-green)' } : {}}
                >
                  Week
                </button>
                <button
                  onClick={() => setView('month')}
                  className={`px-4 py-2 ${view === 'month' ? 'text-white' : 'hover:bg-gray-100'}`}
                  style={view === 'month' ? { backgroundColor: 'var(--dartmouth-green)' } : {}}
                >
                  Month
                </button>
              </div>
              
              <button
                onClick={() => setShowSettings(true)}
                className="p-2 hover:bg-gray-100 rounded"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </button>
              
              <button
                onClick={signOut}
                className="ml-2 px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded"
              >
                Sign Out
              </button>
            </div>
          </div>

          {view === 'day' && renderDayView()}
          {view === 'week' && renderWeekView()}
          {view === 'month' && renderMonthView()}

          {showSettings && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-auto">
                <div className="p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold" style={{ color: 'var(--dartmouth-green)' }}>Settings</h2>
                    <button onClick={() => setShowSettings(false)} className="p-1 hover:bg-gray-100 rounded">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  
                  <div className="space-y-6">
                    <div>
                      <label className="block font-semibold mb-2">Default Calendar</label>
                      <select
                        value={defaultCalendar}
                        onChange={(e) => {
                          setDefaultCalendar(e.target.value);
                          localStorage.setItem('default_calendar', e.target.value);
                        }}
                        className="w-full border rounded px-3 py-2"
                      >
                        {calendars.map(cal => (
                          <option key={cal.id} value={cal.id}>{cal.summary}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div>
                      <h3 className="font-semibold mb-3">Column Configuration</h3>
                      {columns.map(column => (
                        <div key={column.id} className="mb-4 p-4 border rounded">
                          <div className="flex justify-between items-center mb-2">
                            <input
                              type="text"
                              value={column.name}
                              onChange={(e) => {
                                const updated = columns.map(col =>
                                  col.id === column.id ? { ...col, name: e.target.value } : col
                                );
                                setColumns(updated);
                                localStorage.setItem('calendar_columns', JSON.stringify(updated));
                              }}
                              className="font-semibold border rounded px-2 py-1"
                            />
                            {columns.length > 1 && (
                              <button
                                onClick={() => removeColumn(column.id)}
                                className="text-red-600 hover:bg-red-50 p-1 rounded"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                              </button>
                            )}
                          </div>
                          
                          <div className="space-y-1">
                            {calendars.map(cal => (
                              <label key={cal.id} className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input
                                  type="checkbox"
                                  checked={column.calendarIds.includes(cal.id)}
                                  onChange={(e) => {
                                    if (e.target.checked) {
                                      moveCalendarToColumn(cal.id, column.id);
                                    } else {
                                      const updated = columns.map(col => ({
                                        ...col,
                                        calendarIds: col.calendarIds.filter(id => id !== cal.id)
                                      }));
                                      setColumns(updated);
                                      localStorage.setItem('calendar_columns', JSON.stringify(updated));
                                    }
                                  }}
                                  className="rounded"
                                />
                                <div
                                  className="w-3 h-3 rounded"
                                  style={{ backgroundColor: cal.backgroundColor }}
                                />
                                <span className="text-sm">{cal.summary}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>

                    <div className="text-sm text-gray-600 p-3 rounded" style={{ backgroundColor: 'var(--light-green)' }}>
                      <strong>Keyboard Shortcuts:</strong>
                      <div className="mt-2 space-y-1">
                        <div><kbd className="px-2 py-1 bg-white rounded border">D</kbd> - Day view</div>
                        <div><kbd className="px-2 py-1 bg-white rounded border">W</kbd> - Week view</div>
                        <div><kbd className="px-2 py-1 bg-white rounded border">M</kbd> - Month view</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {showEventModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div className="p-6">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold" style={{ color: 'var(--dartmouth-green)' }}>
                      {selectedEvent?.id ? 'Edit Event' : 'New Event'}
                    </h2>
                    <button onClick={() => { setShowEventModal(false); setSelectedEvent(null); }} className="p-1 hover:bg-gray-100 rounded">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  
                  <EventForm
                    event={selectedEvent}
                    calendars={calendars}
                    defaultCalendar={defaultCalendar}
                    onSave={(data) => {
                      if (selectedEvent?.id) {
                        updateEvent({ ...selectedEvent, ...data });
                      } else {
                        createEvent(data);
                      }
                    }}
                    onDelete={selectedEvent?.id ? () => deleteEvent(selectedEvent) : null}
                  />
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const EventForm = ({ event, calendars, defaultCalendar, onSave, onDelete }) => {
      const [title, setTitle] = React.useState(event?.summary || '');
      const [description, setDescription] = React.useState(event?.description || '');
      const getStartTime = () => {
        if (event?.start?.dateTime) return event.start.dateTime.slice(0, 16);
        if (event?.start) return new Date(event.start).toISOString().slice(0, 16);
        return '';
      };
      
      const getEndTime = () => {
        if (event?.end?.dateTime) return event.end.dateTime.slice(0, 16);
        if (event?.end) return new Date(event.end).toISOString().slice(0, 16);
        return '';
      };

      const [start, setStart] = React.useState(getStartTime());
      const [end, setEnd] = React.useState(getEndTime());
      const [calendarId, setCalendarId] = React.useState(event?.calendarId || defaultCalendar || calendars[0]?.id || '');

      return (
        <form onSubmit={(e) => {
          e.preventDefault();
          onSave({ 
            title, 
            description, 
            start: new Date(start).toISOString(), 
            end: new Date(end).toISOString(), 
            calendarId 
          });
        }} className="space-y-4">
          <div>
            <input
              type="text"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className="w-full border-b-2 px-0 py-2 text-xl focus:outline-none"
              placeholder="Add title"
              style={{ borderColor: 'var(--dartmouth-green)' }}
              required
            />
          </div>
          
          <div className="flex gap-4">
            <div className="flex-1">
              <label className="block text-sm font-medium mb-1">Start</label>
              <input
                type="datetime-local"
                value={start}
                onChange={(e) => setStart(e.target.value)}
                className="w-full border rounded px-3 py-2"
                required
              />
            </div>
            
            <div className="flex-1">
              <label className="block text-sm font-medium mb-1">End</label>
              <input
                type="datetime-local"
                value={end}
                onChange={(e) => setEnd(e.target.value)}
                className="w-full border rounded px-3 py-2"
                required
              />
            </div>
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-1">Calendar</label>
            <select
              value={calendarId}
              onChange={(e) => setCalendarId(e.target.value)}
              className="w-full border rounded px-3 py-2"
            >
              {calendars.map(cal => (
                <option key={cal.id} value={cal.id}>{cal.summary}</option>
              ))}
            </select>
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-1">Description</label>
            <textarea
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              className="w-full border rounded px-3 py-2"
              rows={3}
              placeholder="Add description"
            />
          </div>
          
          <div className="flex gap-2 justify-end pt-4">
            {onDelete && (
              <button
                type="button"
                onClick={onDelete}
                className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
              >
                Delete
              </button>
            )}
            <button
              type="submit"
              className="px-6 py-2 text-white rounded hover:opacity-90"
              style={{ backgroundColor: 'var(--dartmouth-green)' }}
            >
              Save
            </button>
          </div>
        </form>
      );
    };

    ReactDOM.render(<CalendarApp />, document.getElementById('root'));
  </script>
</body>
</html>
