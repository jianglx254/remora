<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Calendar App</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const CalendarApp = () => {
      const [isSignedIn, setIsSignedIn] = useState(false);
      const [calendars, setCalendars] = useState([]);
      const [events, setEvents] = useState([]);
      const [view, setView] = useState('day');
      const [currentDate, setCurrentDate] = useState(new Date());
      const [columns, setColumns] = useState([]);
      const [showSettings, setShowSettings] = useState(false);
      const [defaultCalendar, setDefaultCalendar] = useState('');
      const [showEventModal, setShowEventModal] = useState(false);
      const [selectedEvent, setSelectedEvent] = useState(null);
      const clientId = '788943371871-n713sgr9t3oifkev2abln7615eulgbv4.apps.googleusercontent.com';

      useEffect(() => {
        const hash = window.location.hash;
        if (hash) {
          const params = new URLSearchParams(hash.substring(1));
          const accessToken = params.get('access_token');
          if (accessToken) {
            localStorage.setItem('google_access_token', accessToken);
            window.location.hash = '';
            loadCalendarsAndEvents(accessToken);
          }
        } else {
          const token = localStorage.getItem('google_access_token');
          if (token) {
            loadCalendarsAndEvents(token);
          }
        }
      }, []);

      const loadCalendarsAndEvents = async (accessToken) => {
        await loadCalendars(accessToken);
        await loadEvents(accessToken);
        setIsSignedIn(true);
      };

      const signIn = () => {
        const redirectUri = window.location.origin + window.location.pathname;
        const scope = 'https://www.googleapis.com/auth/calendar';
        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${encodeURIComponent(scope)}`;
        window.location.href = authUrl;
      };

      const signOut = () => {
        localStorage.removeItem('google_access_token');
        setIsSignedIn(false);
        setCalendars([]);
        setEvents([]);
      };

      const loadCalendars = async (accessToken) => {
        try {
          const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList', {
            headers: { Authorization: `Bearer ${accessToken}` }
          });
          const data = await response.json();
          setCalendars(data.items || []);
          
          const savedColumns = localStorage.getItem('calendar_columns');
          if (savedColumns) {
            setColumns(JSON.parse(savedColumns));
          } else {
            setColumns([{ id: '1', name: 'Column 1', calendarIds: data.items?.map(cal => cal.id) || [] }]);
          }
          
          if (data.items && data.items.length > 0 && !defaultCalendar) {
            setDefaultCalendar(data.items[0].id);
          }
        } catch (error) {
          console.error('Error loading calendars:', error);
          if (error.message?.includes('401')) {
            signOut();
          }
        }
      };

      const loadEvents = async (accessToken) => {
        try {
          const token = accessToken || localStorage.getItem('google_access_token');
          const timeMin = new Date(currentDate);
          timeMin.setDate(1);
          const timeMax = new Date(currentDate);
          timeMax.setMonth(timeMax.getMonth() + 1);

          const allEvents = [];
          for (const calendar of calendars) {
            const response = await fetch(
              `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.id)}/events?timeMin=${timeMin.toISOString()}&timeMax=${timeMax.toISOString()}&singleEvents=true`,
              { headers: { Authorization: `Bearer ${token}` } }
            );
            const data = await response.json();
            if (data.items) {
              allEvents.push(...data.items.map(event => ({ ...event, calendarId: calendar.id, calendarColor: calendar.backgroundColor })));
            }
          }
          setEvents(allEvents);
        } catch (error) {
          console.error('Error loading events:', error);
        }
      };

      useEffect(() => {
        if (calendars.length > 0 && isSignedIn) {
          loadEvents();
        }
      }, [currentDate, calendars]);

      const createEvent = async (eventData) => {
        try {
          const token = localStorage.getItem('google_access_token');
          const calendarId = eventData.calendarId || defaultCalendar;
          
          const response = await fetch(
            `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`,
            {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                summary: eventData.title,
                description: eventData.description,
                start: { dateTime: eventData.start },
                end: { dateTime: eventData.end }
              })
            }
          );
          
          if (response.ok) {
            await loadEvents();
            setShowEventModal(false);
          }
        } catch (error) {
          console.error('Error creating event:', error);
        }
      };

      const updateEvent = async (eventData) => {
        try {
          const token = localStorage.getItem('google_access_token');
          
          const response = await fetch(
            `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(eventData.calendarId)}/events/${eventData.id}`,
            {
              method: 'PUT',
              headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                summary: eventData.title,
                description: eventData.description,
                start: { dateTime: eventData.start },
                end: { dateTime: eventData.end }
              })
            }
          );
          
          if (response.ok) {
            await loadEvents();
            setShowEventModal(false);
            setSelectedEvent(null);
          }
        } catch (error) {
          console.error('Error updating event:', error);
        }
      };

      const deleteEvent = async (event) => {
        try {
          const token = localStorage.getItem('google_access_token');
          
          await fetch(
            `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(event.calendarId)}/events/${event.id}`,
            {
              method: 'DELETE',
              headers: { Authorization: `Bearer ${token}` }
            }
          );
          
          await loadEvents();
          setShowEventModal(false);
          setSelectedEvent(null);
        } catch (error) {
          console.error('Error deleting event:', error);
        }
      };

      const addColumn = () => {
        const newColumn = {
          id: Date.now().toString(),
          name: `Column ${columns.length + 1}`,
          calendarIds: []
        };
        const updated = [...columns, newColumn];
        setColumns(updated);
        localStorage.setItem('calendar_columns', JSON.stringify(updated));
      };

      const moveCalendarToColumn = (calendarId, targetColumnId) => {
        const updated = columns.map(col => ({
          ...col,
          calendarIds: col.id === targetColumnId 
            ? [...col.calendarIds.filter(id => id !== calendarId), calendarId]
            : col.calendarIds.filter(id => id !== calendarId)
        }));
        setColumns(updated);
        localStorage.setItem('calendar_columns', JSON.stringify(updated));
      };

      const removeColumn = (columnId) => {
        if (columns.length === 1) return;
        const updated = columns.filter(col => col.id !== columnId);
        setColumns(updated);
        localStorage.setItem('calendar_columns', JSON.stringify(updated));
      };

      const renderDayView = () => {
        const hours = Array.from({ length: 18 }, (_, i) => i + 6);
        const dayEvents = events.filter(event => {
          const eventDate = new Date(event.start.dateTime || event.start.date);
          return eventDate.toDateString() === currentDate.toDateString();
        });

        return (
          <div className="flex-1 overflow-auto">
            <div className="flex border-b bg-gray-50">
              <div className="w-16 flex-shrink-0 border-r"></div>
              {columns.map(column => (
                <div key={column.id} className="flex-1 p-2 border-r font-semibold text-center">
                  {column.name}
                </div>
              ))}
            </div>
            
            <div className="flex">
              <div className="w-16 flex-shrink-0">
                {hours.map(hour => (
                  <div key={hour} className="h-16 border-b text-xs text-gray-500 p-1">
                    {hour % 12 || 12}{hour >= 12 ? 'PM' : 'AM'}
                  </div>
                ))}
              </div>
              
              {columns.map(column => (
                <div key={column.id} className="flex-1 border-r relative">
                  {hours.map(hour => (
                    <div
                      key={hour}
                      className="h-16 border-b hover:bg-gray-50 cursor-pointer"
                      onClick={() => {
                        const start = new Date(currentDate);
                        start.setHours(hour, 0, 0, 0);
                        const end = new Date(start);
                        end.setHours(hour + 1);
                        setSelectedEvent({
                          start: start.toISOString(),
                          end: end.toISOString(),
                          calendarId: column.calendarIds[0] || defaultCalendar
                        });
                        setShowEventModal(true);
                      }}
                    />
                  ))}
                  
                  {dayEvents.filter(event => column.calendarIds.includes(event.calendarId)).map(event => {
                    const start = new Date(event.start.dateTime);
                    const end = new Date(event.end.dateTime);
                    const top = ((start.getHours() - 6) * 64) + (start.getMinutes() / 60 * 64);
                    const height = ((end - start) / (1000 * 60 * 60)) * 64;
                    
                    return (
                      <div
                        key={event.id}
                        className="absolute left-1 right-1 rounded p-1 text-xs text-white cursor-pointer overflow-hidden"
                        style={{
                          top: `${top}px`,
                          height: `${height}px`,
                          backgroundColor: event.calendarColor || '#3b82f6'
                        }}
                        onClick={() => {
                          setSelectedEvent(event);
                          setShowEventModal(true);
                        }}
                      >
                        <div className="font-semibold">{event.summary}</div>
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          </div>
        );
      };

      const renderWeekView = () => {
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
        const days = Array.from({ length: 7 }, (_, i) => {
          const day = new Date(startOfWeek);
          day.setDate(startOfWeek.getDate() + i);
          return day;
        });

        return (
          <div className="flex-1 overflow-auto">
            <div className="grid grid-cols-7 gap-px bg-gray-200">
              {days.map(day => (
                <div key={day.toISOString()} className="bg-white p-4 min-h-[500px]">
                  <div className="font-semibold mb-2">
                    {day.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                  </div>
                  {events
                    .filter(event => {
                      const eventDate = new Date(event.start.dateTime || event.start.date);
                      return eventDate.toDateString() === day.toDateString();
                    })
                    .map(event => (
                      <div
                        key={event.id}
                        className="mb-1 p-1 rounded text-xs text-white cursor-pointer"
                        style={{ backgroundColor: event.calendarColor || '#3b82f6' }}
                        onClick={() => {
                          setSelectedEvent(event);
                          setShowEventModal(true);
                        }}
                      >
                        {event.summary}
                      </div>
                    ))}
                </div>
              ))}
            </div>
          </div>
        );
      };

      const renderMonthView = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - startDate.getDay());
        
        const days = [];
        const current = new Date(startDate);
        while (days.length < 42) {
          days.push(new Date(current));
          current.setDate(current.getDate() + 1);
        }

        return (
          <div className="flex-1 overflow-auto p-4">
            <div className="grid grid-cols-7 gap-px bg-gray-200">
              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                <div key={day} className="bg-gray-50 p-2 text-center font-semibold text-sm">
                  {day}
                </div>
              ))}
              {days.map(day => (
                <div
                  key={day.toISOString()}
                  className={`bg-white p-2 min-h-[100px] ${
                    day.getMonth() !== month ? 'text-gray-400' : ''
                  }`}
                >
                  <div className="font-semibold mb-1">{day.getDate()}</div>
                  {events
                    .filter(event => {
                      const eventDate = new Date(event.start.dateTime || event.start.date);
                      return eventDate.toDateString() === day.toDateString();
                    })
                    .slice(0, 3)
                    .map(event => (
                      <div
                        key={event.id}
                        className="mb-1 p-1 rounded text-xs text-white cursor-pointer truncate"
                        style={{ backgroundColor: event.calendarColor || '#3b82f6' }}
                        onClick={() => {
                          setSelectedEvent(event);
                          setShowEventModal(true);
                        }}
                      >
                        {event.summary}
                      </div>
                    ))}
                </div>
              ))}
            </div>
          </div>
        );
      };

      if (!isSignedIn) {
        return (
          <div className="h-screen bg-gray-50 flex items-center justify-center">
            <div className="bg-white rounded-lg shadow-lg p-8 text-center">
              <svg className="w-16 h-16 mx-auto mb-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <h1 className="text-2xl font-bold mb-4">Custom Calendar App</h1>
              <button
                onClick={signIn}
                className="bg-blue-600 text-white rounded px-6 py-3 hover:bg-blue-700"
              >
                Sign in with Google
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="h-screen flex flex-col bg-white">
          <div className="border-b p-4 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <h1 className="text-xl font-bold">Calendar</h1>
              
              <div className="flex items-center gap-2 ml-8">
                <button
                  onClick={() => {
                    const newDate = new Date(currentDate);
                    if (view === 'day') newDate.setDate(newDate.getDate() - 1);
                    else if (view === 'week') newDate.setDate(newDate.getDate() - 7);
                    else newDate.setMonth(newDate.getMonth() - 1);
                    setCurrentDate(newDate);
                  }}
                  className="p-1 hover:bg-gray-100 rounded"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                
                <button
                  onClick={() => setCurrentDate(new Date())}
                  className="px-3 py-1 hover:bg-gray-100 rounded"
                >
                  Today
                </button>
                
                <button
                  onClick={() => {
                    const newDate = new Date(currentDate);
                    if (view === 'day') newDate.setDate(newDate.getDate() + 1);
                    else if (view === 'week') newDate.setDate(newDate.getDate() + 7);
                    else newDate.setMonth(newDate.getMonth() + 1);
                    setCurrentDate(newDate);
                  }}
                  className="p-1 hover:bg-gray-100 rounded"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </button>
                
                <span className="ml-4 font-semibold">
                  {currentDate.toLocaleDateString('en-US', { 
                    month: 'long', 
                    day: view === 'day' ? 'numeric' : undefined,
                    year: 'numeric' 
                  })}
                </span>
              </div>
            </div>
            
            <div className="flex items-center gap-2">
              <div className="flex border rounded overflow-hidden">
                <button
                  onClick={() => setView('day')}
                  className={`px-4 py-2 ${view === 'day' ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}`}
                >
                  Day
                </button>
                <button
                  onClick={() => setView('week')}
                  className={`px-4 py-2 ${view === 'week' ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}`}
                >
                  Week
                </button>
                <button
                  onClick={() => setView('month')}
                  className={`px-4 py-2 ${view === 'month' ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}`}
                >
                  Month
                </button>
              </div>
              
              {view === 'day' && (
                <button
                  onClick={addColumn}
                  className="p-2 hover:bg-gray-100 rounded"
                  title="Add Column"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                  </svg>
                </button>
              )}
              
              <button
                onClick={() => setShowSettings(true)}
                className="p-2 hover:bg-gray-100 rounded"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </button>
              
              <button
                onClick={signOut}
                className="ml-2 px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded"
              >
                Sign Out
              </button>
            </div>
          </div>

          {view === 'day' && renderDayView()}
          {view === 'week' && renderWeekView()}
          {view === 'month' && renderMonthView()}

          {showSettings && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-auto">
                <div className="p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold">Settings</h2>
                    <button onClick={() => setShowSettings(false)} className="p-1 hover:bg-gray-100 rounded">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  
                  <div className="space-y-6">
                    <div>
                      <label className="block font-semibold mb-2">Default Calendar</label>
                      <select
                        value={defaultCalendar}
                        onChange={(e) => setDefaultCalendar(e.target.value)}
                        className="w-full border rounded px-3 py-2"
                      >
                        {calendars.map(cal => (
                          <option key={cal.id} value={cal.id}>{cal.summary}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div>
                      <h3 className="font-semibold mb-3">Column Configuration</h3>
                      {columns.map(column => (
                        <div key={column.id} className="mb-4 p-4 border rounded">
                          <div className="flex justify-between items-center mb-2">
                            <input
                              type="text"
                              value={column.name}
                              onChange={(e) => {
                                const updated = columns.map(col =>
                                  col.id === column.id ? { ...col, name: e.target.value } : col
                                );
                                setColumns(updated);
                                localStorage.setItem('calendar_columns', JSON.stringify(updated));
                              }}
                              className="font-semibold border rounded px-2 py-1"
                            />
                            {columns.length > 1 && (
                              <button
                                onClick={() => removeColumn(column.id)}
                                className="text-red-600 hover:bg-red-50 p-1 rounded"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                              </button>
                            )}
                          </div>
                          
                          <div className="space-y-1">
                            {calendars.map(cal => (
                              <label key={cal.id} className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input
                                  type="checkbox"
                                  checked={column.calendarIds.includes(cal.id)}
                                  onChange={(e) => {
                                    if (e.target.checked) {
                                      moveCalendarToColumn(cal.id, column.id);
                                    } else {
                                      const updated = columns.map(col => ({
                                        ...col,
                                        calendarIds: col.calendarIds.filter(id => id !== cal.id)
                                      }));
                                      setColumns(updated);
                                      localStorage.setItem('calendar_columns', JSON.stringify(updated));
                                    }
                                  }}
                                  className="rounded"
                                />
                                <div
                                  className="w-3 h-3 rounded"
                                  style={{ backgroundColor: cal.backgroundColor }}
                                />
                                <span className="text-sm">{cal.summary}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {showEventModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div className="p-6">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold">{selectedEvent?.id ? 'Edit Event' : 'New Event'}</h2>
                    <button onClick={() => { setShowEventModal(false); setSelectedEvent(null); }} className="p-1 hover:bg-gray-100 rounded">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  
                  <EventForm
                    event={selectedEvent}
                    calendars={calendars}
                    onSave={(data) => {
                      if (selectedEvent?.id) {
                        updateEvent({ ...selectedEvent, ...data });
                      } else {
                        createEvent(data);
                      }
                    }}
                    onDelete={selectedEvent?.id ? () => deleteEvent(selectedEvent) : null}
                  />
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const EventForm = ({ event, calendars, onSave, onDelete }) => {
      const [title, setTitle] = React.useState(event?.summary || '');
      const [description, setDescription] = React.useState(event?.description || '');
      const [start, setStart] = React.useState(event?.start?.dateTime ? event.start.dateTime.slice(0, 16)
